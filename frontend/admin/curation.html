<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curation & Training - Admin Dashboard</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        /* Curation-specific styles */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-top: 4px solid;
        }

        .stat-card.pending { border-top-color: #f59e0b; }
        .stat-card.approved { border-top-color: #10b981; }
        .stat-card.rejected { border-top-color: #ef4444; }
        .stat-card.training { border-top-color: #00B9DA; }

        .stat-label {
            font-size: 13px;
            color: #718096;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #00B9DA 0%, #f31c7e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .filter-section {
            background: white;
            padding: 25px 30px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
        }

        .filter-select {
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            min-width: 180px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #00B9DA;
        }

        .filter-search {
            flex: 1;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #00B9DA;
        }

        .rec-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .rec-card:hover {
            border-color: #00B9DA;
            box-shadow: 0 6px 20px rgba(0, 185, 218, 0.15);
        }

        .rec-card.pending {
            border-left: 6px solid #f59e0b;
        }

        .rec-card.flagged {
            border-left: 6px solid #ef4444;
        }

        .rec-header {
            background: #f7fafc;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rec-meta {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .rec-id {
            font-size: 12px;
            font-weight: 700;
            color: #718096;
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
        }

        .rec-status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-flagged {
            background: #fee2e2;
            color: #991b1b;
        }

        .rec-category {
            font-size: 13px;
            color: #4a5568;
            font-weight: 600;
        }

        .rec-body {
            padding: 25px;
        }

        .rec-title-input, .rec-content-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
            font-family: inherit;
        }

        .rec-content-textarea {
            min-height: 150px;
            line-height: 1.7;
            font-weight: normal;
            resize: vertical;
        }

        .rec-title-input:focus, .rec-content-textarea:focus {
            outline: none;
            border-color: #00B9DA;
        }

        .rec-metadata-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .metadata-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
        }

        .metadata-label {
            font-size: 11px;
            font-weight: 700;
            color: #718096;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .metadata-value {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
        }

        .ai-quality-section {
            background: linear-gradient(135deg, #7D41A5 0%, #f31c7e 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
        }

        .ai-quality-section.flagged {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .ai-quality-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .ai-quality-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .ai-score {
            font-size: 24px;
            font-weight: 800;
        }

        .ai-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .ai-metric {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .ai-metric-value {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .ai-metric-label {
            font-size: 11px;
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .btn-approve {
            flex: 1;
            background: #10b981;
            color: white;
            padding: 14px;
            border-radius: 8px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-approve:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-reject {
            flex: 1;
            background: #ef4444;
            color: white;
            padding: 14px;
            border-radius: 8px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-reject:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-edit {
            background: #00B9DA;
            color: white;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit:hover {
            background: #0096b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 185, 218, 0.3);
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="logo-section">
            <div class="logo">AI Visibility Score</div>
            <div class="logo-subtitle">Admin Control Center</div>
        </div>

        <nav>
            <div class="nav-section">
                <div class="nav-title">Dashboard</div>
                <a href="overview.html" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Overview</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üéØ</span>
                    <span>Opportunities</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">Management</div>
                <a href="users.html" class="nav-item">
                    <span class="nav-icon">üë•</span>
                    <span>Users</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üí∞</span>
                    <span>Revenue</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üîç</span>
                    <span>Scans</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìù</span>
                    <span>Recommendations</span>
                </a>
                <a href="curation.html" class="nav-item active">
                    <span class="nav-icon">‚úèÔ∏è</span>
                    <span>Curation & Training</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">System</div>
                <a href="#" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>System Health</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üö®</span>
                    <span>Alerts</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">üìß</span>
                    <span>Email Campaigns</span>
                </a>
                <a href="#" class="nav-item">
                    <span class="nav-icon">‚ö°</span>
                    <span>API Usage</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">Account</div>
                <a href="#" class="nav-item" onclick="AdminUtils.logout(); return false;">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="top-header">
            <div class="header-left">
                <h1>Recommendation Curation & Training</h1>
                <p class="header-subtitle">Review, edit, and improve AI-generated recommendations</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary">üìä Export Training Data</button>
                <a href="overview.html" class="btn btn-secondary" style="text-decoration: none;">‚Üê Back to Dashboard</a>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card pending">
                <div class="stat-label">Pending Review</div>
                <div class="stat-value" id="pendingCount">-</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-label">Approved This Week</div>
                <div class="stat-value" id="approvedCount">-</div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-label">Rejected/Revised</div>
                <div class="stat-value" id="rejectedCount">-</div>
            </div>
            <div class="stat-card training">
                <div class="stat-label">In Training Queue</div>
                <div class="stat-value" id="trainingCount">-</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select class="filter-select" id="statusFilter">
                    <option value="pending" selected>Pending Review</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="flagged">Flagged</option>
                    <option value="all">All</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Category</label>
                <select class="filter-select" id="categoryFilter">
                    <option value="all">All Categories</option>
                    <option value="AI Readability">AI Readability</option>
                    <option value="AI Search Readiness">AI Search Readiness</option>
                    <option value="Technical Setup">Technical Setup</option>
                    <option value="Speed & UX">Speed & UX</option>
                    <option value="Content Structure">Content Structure</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Quality Score</label>
                <select class="filter-select" id="qualityFilter">
                    <option value="0">All Scores</option>
                    <option value="90">90-100 (Excellent)</option>
                    <option value="70">70-89 (Good)</option>
                    <option value="50">50-69 (Needs Work)</option>
                </select>
            </div>

            <div class="filter-group filter-search">
                <label class="filter-label">Search</label>
                <input type="text" class="search-input" id="searchInput" placeholder="Search by keyword, ID, or issue...">
            </div>

            <button class="btn btn-primary" onclick="applyFilters()">üîç Apply Filters</button>
        </div>

        <!-- Recommendation Queue -->
        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">Recommendation Queue (<span id="queueCount">0</span> pending)</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary">Select All</button>
                    <button class="btn btn-primary">Bulk Approve (0)</button>
                </div>
            </div>

            <div id="recommendationsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading recommendations...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="admin.js"></script>
    <script>
        let currentFilters = {
            status: 'pending',
            subfactor: 'all',
            qualityMin: 0,
            search: ''
        };

        // Initialize
        async function init() {
            const token = await AdminUtils.checkAdminAuth();
            if (!token) return;

            await loadStats();
            await loadQueue();
        }

        // Load stats
        async function loadStats() {
            try {
                const data = await AdminUtils.apiRequest('/admin/curation/stats');
                const stats = data.data;

                document.getElementById('pendingCount').textContent = stats.pending_review || 0;
                document.getElementById('approvedCount').textContent = stats.approved_this_week || 0;
                document.getElementById('rejectedCount').textContent = stats.rejected || 0;
                document.getElementById('trainingCount').textContent = stats.in_training_queue || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load queue
        async function loadQueue() {
            try {
                const params = new URLSearchParams(currentFilters);
                const data = await AdminUtils.apiRequest(`/admin/curation/queue?${params}`);
                const recommendations = data.data.recommendations;

                document.getElementById('queueCount').textContent = recommendations.length;
                renderRecommendations(recommendations);
            } catch (error) {
                console.error('Failed to load queue:', error);
                document.getElementById('recommendationsList').innerHTML = `
                    <div class="error-message">Failed to load recommendations: ${error.message}</div>
                `;
            }
        }

        // Render recommendations
        function renderRecommendations(recommendations) {
            const container = document.getElementById('recommendationsList');

            if (recommendations.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 60px; color: #718096;">No recommendations to review</p>';
                return;
            }

            const html = recommendations.map(rec => {
                const isFlagged = rec.is_flagged;
                const qualityClass = rec.quality_score >= 70 ? '' : 'flagged';

                return `
                    <div class="rec-card ${rec.status} ${isFlagged ? 'flagged' : ''}">
                        <div class="rec-header">
                            <div class="rec-meta">
                                <span class="rec-id">REC-${rec.id}</span>
                                <span class="rec-status status-${rec.status}">${rec.status}</span>
                                <span class="rec-category">${rec.subfactor || 'Unknown'}</span>
                            </div>
                            <div>${AdminUtils.formatDate(rec.created_at)}</div>
                        </div>

                        <div class="rec-body">
                            <div style="margin-bottom: 20px;">
                                <label style="font-size: 12px; font-weight: 700; color: #718096; text-transform: uppercase; margin-bottom: 8px; display: block;">Recommendation Title</label>
                                <input type="text" class="rec-title-input" id="title-${rec.id}" value="${rec.edited_title || rec.original_title || ''}" />
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="font-size: 12px; font-weight: 700; color: #718096; text-transform: uppercase; margin-bottom: 8px; display: block;">Recommendation Content</label>
                                <textarea class="rec-content-textarea" id="content-${rec.id}">${rec.edited_content || rec.original_content || ''}</textarea>
                            </div>

                            <div class="rec-metadata-grid">
                                <div class="metadata-item">
                                    <div class="metadata-label">Priority</div>
                                    <div class="metadata-value">${rec.original_priority || 'Medium'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-label">Effort Level</div>
                                    <div class="metadata-value">${rec.original_effort || 'Unknown'}</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-label">Score Impact</div>
                                    <div class="metadata-value">${rec.original_impact ? '+' + rec.original_impact + ' points' : 'Unknown'}</div>
                                </div>
                            </div>

                            <div class="ai-quality-section ${qualityClass}">
                                <div class="ai-quality-header">
                                    <span class="ai-quality-title">${isFlagged ? 'üö® Quality Issues Detected' : 'ü§ñ AI Quality Analysis'}</span>
                                    <span class="ai-score">${rec.quality_score || 0}/100</span>
                                </div>
                                <div class="ai-metrics">
                                    <div class="ai-metric">
                                        <div class="ai-metric-value">${rec.clarity_score || 0}%</div>
                                        <div class="ai-metric-label">Clarity</div>
                                    </div>
                                    <div class="ai-metric">
                                        <div class="ai-metric-value">${rec.actionability_score || 0}%</div>
                                        <div class="ai-metric-label">Actionability</div>
                                    </div>
                                    <div class="ai-metric">
                                        <div class="ai-metric-value">${rec.specificity_score || 0}%</div>
                                        <div class="ai-metric-label">Specificity</div>
                                    </div>
                                    <div class="ai-metric">
                                        <div class="ai-metric-value">${rec.relevance_score || 0}%</div>
                                        <div class="ai-metric-label">Relevance</div>
                                    </div>
                                </div>
                                ${isFlagged ? `<div style="margin-top: 15px; font-size: 13px; opacity: 0.95;">‚ö†Ô∏è ${rec.flag_reason}</div>` : ''}
                            </div>

                            <div class="action-buttons">
                                <button class="btn-approve" onclick="approveRec(${rec.id})" ${isFlagged && rec.quality_score < 50 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>‚úì Approve & Train</button>
                                <button class="btn-edit" onclick="saveEdit(${rec.id})">‚úèÔ∏è Edit & Save</button>
                                <button class="btn-reject" onclick="rejectRec(${rec.id})">‚úó Reject</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Apply filters
        function applyFilters() {
            currentFilters = {
                status: document.getElementById('statusFilter').value,
                subfactor: document.getElementById('categoryFilter').value,
                qualityMin: parseInt(document.getElementById('qualityFilter').value),
                search: document.getElementById('searchInput').value.trim()
            };
            loadQueue();
        }

        // Approve recommendation
        async function approveRec(id) {
            const notes = prompt('Approval notes (optional):');
            if (notes === null) return;

            try {
                await AdminUtils.apiRequest(`/admin/curation/${id}/approve`, {
                    method: 'POST',
                    body: JSON.stringify({ notes })
                });

                AdminUtils.showToast('Recommendation approved and added to training!', 'success');
                loadStats();
                loadQueue();
            } catch (error) {
                AdminUtils.showToast(`Failed to approve: ${error.message}`, 'error');
            }
        }

        // Save edit
        async function saveEdit(id) {
            const title = document.getElementById(`title-${id}`).value;
            const content = document.getElementById(`content-${id}`).value;

            try {
                await AdminUtils.apiRequest(`/admin/curation/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        edited_title: title,
                        edited_content: content,
                        curator_notes: 'Edited via admin panel'
                    })
                });

                AdminUtils.showToast('Recommendation updated!', 'success');
                loadQueue();
            } catch (error) {
                AdminUtils.showToast(`Failed to save: ${error.message}`, 'error');
            }
        }

        // Reject recommendation
        async function rejectRec(id) {
            const reason = prompt('Rejection reason (required):');
            if (!reason) {
                AdminUtils.showToast('Rejection reason is required', 'error');
                return;
            }

            try {
                await AdminUtils.apiRequest(`/admin/curation/${id}/reject`, {
                    method: 'POST',
                    body: JSON.stringify({ reason })
                });

                AdminUtils.showToast('Recommendation rejected and added to negative training!', 'success');
                loadStats();
                loadQueue();
            } catch (error) {
                AdminUtils.showToast(`Failed to reject: ${error.message}`, 'error');
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
