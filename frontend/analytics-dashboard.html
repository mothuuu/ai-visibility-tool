<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendation Quality Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    Recommendation Quality Analytics
                </h1>
                <a href="dashboard.html" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Date Range Filter -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Filter Options</h2>
            <div class="flex gap-4 items-end">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
                    <select id="timePeriod" onchange="loadAnalytics()" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subfactor (Optional)</label>
                    <select id="subfactorFilter" onchange="loadAnalytics()" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        <option value="">All Recommendations</option>
                        <option value="scannabilityScore">Scannability</option>
                        <option value="readabilityScore">Readability</option>
                        <option value="contentDepthScore">Content Depth</option>
                        <option value="headingHierarchyScore">Heading Hierarchy</option>
                        <option value="altTextScore">Alt Text</option>
                        <option value="sitemapScore">Sitemap</option>
                        <option value="robotsTxtScore">Robots.txt</option>
                        <option value="httpsScore">HTTPS</option>
                    </select>
                </div>
                <button onclick="loadAnalytics()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                    Refresh Data
                </button>
            </div>
        </div>

        <!-- Overall Summary Cards -->
        <div id="summaryCards" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Cards will be inserted here -->
        </div>

        <!-- Top Performers & Needs Improvement -->
        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <!-- Top Performers -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <span>üèÜ</span>
                    <span>Top Performing Recommendations</span>
                </h3>
                <div id="topPerformers" class="space-y-3">
                    <!-- Will be populated -->
                </div>
            </div>

            <!-- Needs Improvement -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <span>‚ö†Ô∏è</span>
                    <span>Needs Improvement</span>
                </h3>
                <div id="needsImprovement" class="space-y-3">
                    <!-- Will be populated -->
                </div>
            </div>
        </div>

        <!-- Detailed Metrics Table -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Detailed Metrics by Recommendation</h3>
            <div class="overflow-x-auto">
                <table class="w-full" id="metricsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Recommendation</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Total Ratings</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Avg Rating</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Helpful Rate</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Implementation Rate</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Avg Time Spent</th>
                        </tr>
                    </thead>
                    <tbody id="metricsTableBody">
                        <!-- Will be populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Comments -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Recent Feedback Comments</h3>
            <div id="recentComments" class="space-y-4">
                <!-- Will be populated -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001/api'
            : 'https://your-production-api.com/api';

        async function loadAnalytics() {
            const days = document.getElementById('timePeriod').value;
            const subfactor = document.getElementById('subfactorFilter').value;

            try {
                // Load summary data
                const summaryResponse = await fetch(`${API_BASE_URL}/feedback/analytics/summary?days=${days}`);
                const summaryData = await summaryResponse.json();

                if (summaryData.success) {
                    renderSummaryCards(summaryData.summary);
                    renderTopPerformers(summaryData.topPerformers);
                    renderNeedsImprovement(summaryData.needsImprovement);
                }

                // Load detailed quality metrics
                const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();
                const endDate = new Date().toISOString();

                const metricsResponse = await fetch(
                    `${API_BASE_URL}/feedback/analytics/quality?startDate=${startDate}&endDate=${endDate}${subfactor ? `&subfactor=${subfactor}` : ''}`
                );
                const metricsData = await metricsResponse.json();

                if (metricsData.success) {
                    renderMetricsTable(metricsData.metrics);
                    renderRecentComments(metricsData.recentComments);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                alert('Failed to load analytics data. Please check console for details.');
            }
        }

        function renderSummaryCards(summary) {
            const container = document.getElementById('summaryCards');
            container.innerHTML = `
                <div class="metric-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600 text-sm font-medium">Total Feedback</span>
                        <span class="text-3xl">üìä</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-900">${summary.total_feedback || 0}</div>
                    <div class="text-sm text-gray-500 mt-1">${summary.unique_users || 0} users</div>
                </div>

                <div class="metric-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600 text-sm font-medium">Avg Rating</span>
                        <span class="text-3xl">‚≠ê</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-900">${summary.overall_avg_rating || 'N/A'} / 5</div>
                    <div class="text-sm ${parseFloat(summary.overall_avg_rating) >= 4 ? 'text-green-600' : 'text-orange-600'} mt-1">
                        ${parseFloat(summary.overall_avg_rating) >= 4 ? '‚úì Excellent' : '‚ö† Needs improvement'}
                    </div>
                </div>

                <div class="metric-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600 text-sm font-medium">Helpful Rate</span>
                        <span class="text-3xl">üëç</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-900">${summary.overall_helpful_rate || 0}%</div>
                    <div class="text-sm text-gray-500 mt-1">${summary.total_helpful || 0} helpful</div>
                </div>

                <div class="metric-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600 text-sm font-medium">Implementation Rate</span>
                        <span class="text-3xl">‚úÖ</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-900">${summary.overall_implementation_rate || 0}%</div>
                    <div class="text-sm text-gray-500 mt-1">${summary.total_implemented || 0} implemented</div>
                </div>
            `;
        }

        function renderTopPerformers(performers) {
            const container = document.getElementById('topPerformers');
            if (!performers || performers.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No data available yet</p>';
                return;
            }

            container.innerHTML = performers.map((perf, idx) => `
                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                    <div>
                        <div class="font-semibold text-gray-900">${idx + 1}. ${formatSubfactorName(perf.subfactor)}</div>
                        <div class="text-sm text-gray-600">${perf.rating_count} ratings</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-green-700">‚≠ê ${perf.avg_rating}</div>
                        <div class="text-xs text-gray-600">${perf.implementation_rate}% impl</div>
                    </div>
                </div>
            `).join('');
        }

        function renderNeedsImprovement(items) {
            const container = document.getElementById('needsImprovement');
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-gray-500">All recommendations performing well! üéâ</p>';
                return;
            }

            container.innerHTML = items.map((item, idx) => `
                <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900">${idx + 1}. ${formatSubfactorName(item.subfactor)}</div>
                        <div class="text-sm text-gray-600">${item.rating_count} ratings</div>
                        ${item.sample_comments && item.sample_comments.length > 0 ? `
                            <div class="text-xs text-gray-500 mt-1 italic">
                                "${item.sample_comments[0].substring(0, 60)}..."
                            </div>
                        ` : ''}
                    </div>
                    <div class="text-right ml-4">
                        <div class="font-bold text-orange-700">‚≠ê ${item.avg_rating}</div>
                        <div class="text-xs text-gray-600">${item.not_helpful_rate}% not helpful</div>
                    </div>
                </div>
            `).join('');
        }

        function renderMetricsTable(metrics) {
            const tbody = document.getElementById('metricsTableBody');
            if (!metrics || metrics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No data available</td></tr>';
                return;
            }

            tbody.innerHTML = metrics.map(metric => `
                <tr class="border-t border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-3">${formatSubfactorName(metric.subfactor)}</td>
                    <td class="px-4 py-3 text-center">${metric.total_ratings}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center gap-1">
                            ${getRatingStars(parseFloat(metric.avg_rating))}
                            <span class="font-semibold">${metric.avg_rating || 'N/A'}</span>
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                            parseFloat(metric.helpful_rate) >= 75 ? 'bg-green-100 text-green-800' :
                            parseFloat(metric.helpful_rate) >= 50 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${metric.helpful_rate || 0}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">${metric.implementation_rate || 0}%</td>
                    <td class="px-4 py-3 text-center">${formatDuration(metric.avg_time_spent)}</td>
                </tr>
            `).join('');
        }

        function renderRecentComments(comments) {
            const container = document.getElementById('recentComments');
            if (!comments || comments.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No comments yet</p>';
                return;
            }

            container.innerHTML = comments.slice(0, 10).map(comment => `
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-gray-900">${formatSubfactorName(comment.subfactor)}</span>
                            <span class="text-sm text-gray-600">
                                ${comment.helpful ? 'üëç Helpful' : 'üëé Not helpful'}
                            </span>
                            ${comment.rating ? `<span class="text-sm">‚≠ê ${comment.rating}/5</span>` : ''}
                        </div>
                        <span class="text-xs text-gray-500">${formatDate(comment.created_at)}</span>
                    </div>
                    <p class="text-gray-700 text-sm">"${comment.comment}"</p>
                </div>
            `).join('');
        }

        function formatSubfactorName(subfactor) {
            const names = {
                'scannabilityScore': 'Content Scannability',
                'readabilityScore': 'Readability & Clarity',
                'contentDepthScore': 'Content Depth',
                'headingHierarchyScore': 'Heading Hierarchy',
                'altTextScore': 'Alt Text for Images',
                'sitemapScore': 'XML Sitemap',
                'robotsTxtScore': 'Robots.txt Config',
                'httpsScore': 'HTTPS/SSL Security'
            };
            return names[subfactor] || subfactor;
        }

        function getRatingStars(rating) {
            const fullStars = Math.floor(rating);
            return '‚≠ê'.repeat(fullStars);
        }

        function formatDuration(seconds) {
            if (!seconds) return 'N/A';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load analytics on page load
        loadAnalytics();
    </script>

    <!-- AI Support Chat Widget -->
    <script src="support-chat.js"></script>
</body>
</html>
