<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Visibility Score - Real-Time Assessment</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Auth Check -->
    <div id="authCheck" style="display: none; text-align: center; padding: 100px 20px;">
        <div class="loading-spinner"></div>
        <p>Checking authentication...</p>
    </div>

    <!-- Main content -->
    <div class="container" id="mainContent" style="display: none;">
        <div class="header">
            <h1>AI Visibility Score</h1>
            <p>Real-time analysis of how AI assistants find and recommend your website</p>
        </div>

        <div class="main-content">
            <div class="input-section" id="inputSection">
                <h2>Get Your Real-Time AI Marketing Assessment</h2>
                <form class="url-form" id="urlForm">
                    <input 
                        type="url" 
                        class="url-input" 
                        id="websiteUrl" 
                        placeholder="Enter your website URL (e.g., https://yourcompany.com)"
                        required
                    >
                    <input type="hidden" name="page_url" id="page_url" value="" />
                    <button type="submit" class="analyze-btn" id="analyzeBtn">
                        Analyze My Website
                    </button>
                </form>
                <p class="disclaimer">
                    ✓ Real-time analysis ✓ Tests actual AI assistants ✓ No signup required
                </p>
            </div>

            <div class="loading" id="loadingSection">
                <div class="loading-spinner"></div>
                <div class="loading-text" id="loadingText">Fetching website content...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="error-section" id="errorSection">
                <h3>Analysis Error</h3>
                <p id="errorMessage">Unable to analyze the website. Please check the URL and try again.</p>
                <button class="analyze-btn" onclick="resetForm()">Try Again</button>
            </div>

            <div class="results" id="resultsSection">
                <div class="industry-detection" id="industryDetection">
                    <h3>Website Analysis</h3>
                    <p id="detectedIndustry">Professional Services</p>
                    <p id="websiteStats"></p>
                </div>

                <div class="score-header">
                    <div class="score-circle" id="scoreCircle">
                        <span id="totalScore">67</span><span>/100</span>
                    </div>
                    <h2 id="scoreTitle">Your AI Visibility Score</h2>
                    <p id="scoreDescription">Results description will appear here</p>
                </div>

                <div class="score-categories" id="scoreCategories">
                    <!-- Categories populated by JavaScript -->
                </div>

                <div class="ai-visibility-results" id="aiVisibilityResults">
                    <!-- AI visibility results populated by JavaScript -->
                </div>

                <div class="recommendations">
                    <h3>Priority Improvements for AI Visibility</h3>
                    <div class="quick-wins" id="quickWins">
                        <!-- Recommendations populated by JavaScript -->
                    </div>
                </div>

                <div class="analysis-details">
                    <h5>Analysis Details</h5>
                    <div id="analysisBreakdown"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Powered by Xeo AI Hub | AI Readiness Assessment Tool</p>
        </div>
    </div>

    <!-- Hidden iframe prevents page redirect on sidecar submit -->
    <iframe name="gsheet_silent_target" style="display:none;"></iframe>

    <!-- Hidden form that posts to your Google Sheet Apps Script -->
    <form id="sheetForm" method="POST" action="https://script.google.com/macros/s/AKfycby39Oc9Q_MhbFNTuV0telbuRC8ffb7Ts_TG2oaArxuDFxtW_w4tpjuab0x5YC4uBqjPew/exec" target="gsheet_silent_target" style="display:none;">
        <input type="hidden" name="website" id="sheet_website" />
        <input type="hidden" name="page_url" id="sheet_page_url" />
        <input type="hidden" name="user_agent" id="sheet_user_agent" />
        <input type="hidden" name="ip" id="sheet_ip" />
        <input type="hidden" name="referrer" id="sheet_referrer" />
    </form>

    <script>
        // Auth check before loading app
        (function() {
            const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:3001/api'
                : 'https://ai-visibility-tool.onrender.com/api';
            
            const authCheck = document.getElementById('authCheck');
            const mainContent = document.getElementById('mainContent');
            const token = localStorage.getItem('authToken');
            const hasScannedBefore = localStorage.getItem('hasScanned');
            
            // FREEMIUM LOGIC: Allow first scan without auth
            if (!token) {
                if (hasScannedBefore) {
                    // Returning freemium user → require signup for 2nd scan
                    window.location.href = 'auth.html?reason=limit';
                    return;
                } else {
                    // First-time visitor → allow access
                    authCheck.style.display = 'none';
                    mainContent.style.display = 'block';
                    return;
                }
            }
            
            // LOGGED-IN USER: Verify token
            authCheck.style.display = 'block';
            fetch(`${API_BASE_URL}/auth/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => {
                if (!res.ok) throw new Error('Invalid token');
                return res.json();
            })
            .then(data => {
                localStorage.setItem('user', JSON.stringify(data.user));
                authCheck.style.display = 'none';
                mainContent.style.display = 'block';
            })
            .catch(err => {
                console.error('Auth check failed:', err);
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = 'auth.html';
            });
        })();
    </script>
    <script src="script.js"></script>
</body>
</html>